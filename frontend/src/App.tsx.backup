import { useState, useCallback } from 'react';

function App() {
  console.log('=== APP COMPONENT RENDERING ===');
  
  return (
    <div style={{ 
      width: '100vw', 
      height: '100vh', 
      background: 'linear-gradient(to right, #667eea, #764ba2)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      color: 'white',
      fontSize: '24px',
      fontFamily: 'system-ui'
    }}>
      <div style={{ textAlign: 'center' }}>
        <h1 style={{ fontSize: '48px', marginBottom: '20px' }}>ðŸ”¬ Optical Setup Designer</h1>
        <p>React is working! Loading components...</p>
      </div>
    </div>
  );
}

export default App;
import {
  OpticalComponent,
  ComponentType,
  SimulationSettings,
  SimulationResult,
  SourceComponent,
  MirrorComponent,
  LensComponent,
  DetectorComponent,
} from './types/optical';
import { generateId, getDefaultProperties, downloadJSON } from './utils/helpers';
import { simulateOpticalSetup } from './utils/api';

function AppFull() {
  console.log('App component rendering...');
  
  const [components, setComponents] = useState<OpticalComponent[]>([]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [simulationSettings, setSimulationSettings] = useState<SimulationSettings>({
    freqStart: 400,
    freqStop: 700,
    freqPoints: 10,
  });
  const [simulationResult, setSimulationResult] = useState<SimulationResult | null>(null);
  const [isSimulating, setIsSimulating] = useState(false);

  // Add a new component to the canvas
  const handleAddComponent = useCallback((type: ComponentType) => {
    const id = generateId(type);
    const position = {
      x: 400 + Math.random() * 200,
      y: 300 + Math.random() * 200,
    };

    const baseComponent = {
      id,
      type,
      position,
      rotation: 0,
    };

    let newComponent: OpticalComponent;

    switch (type) {
      case 'source':
        newComponent = {
          ...baseComponent,
          type: 'source',
          properties: getDefaultProperties('source'),
        } as SourceComponent;
        break;
      case 'mirror':
        newComponent = {
          ...baseComponent,
          type: 'mirror',
          properties: getDefaultProperties('mirror'),
        } as MirrorComponent;
        break;
      case 'lens':
        newComponent = {
          ...baseComponent,
          type: 'lens',
          properties: getDefaultProperties('lens'),
        } as LensComponent;
        break;
      case 'detector':
        newComponent = {
          ...baseComponent,
          type: 'detector',
          properties: getDefaultProperties('detector'),
        } as DetectorComponent;
        break;
      default:
        return;
    }

    setComponents((prev) => [...prev, newComponent]);
    setSelectedId(id);
  }, []);

  // Update a component
  const handleUpdateComponent = useCallback(
    (id: string, updates: Partial<OpticalComponent>) => {
      setComponents((prev) =>
        prev.map((comp) =>
          comp.id === id ? { ...comp, ...updates } : comp
        )
      );
    },
    []
  );

  // Delete a component
  const handleDeleteComponent = useCallback((id: string) => {
    setComponents((prev) => prev.filter((comp) => comp.id !== id));
    setSelectedId(null);
  }, []);

  // Get selected component
  const selectedComponent = components.find((c) => c.id === selectedId) || null;

  // Run simulation
  const handleRunSimulation = useCallback(async () => {
    if (components.length === 0) {
      alert('Please add some components first!');
      return;
    }

    setIsSimulating(true);
    try {
      const result = await simulateOpticalSetup({
        components,
        simulationSettings,
      });
      setSimulationResult(result);
    } catch (error) {
      console.error('Simulation failed:', error);
      alert('Simulation failed. Make sure the backend is running.');
    } finally {
      setIsSimulating(false);
    }
  }, [components, simulationSettings]);

  // Export setup as JSON
  const handleExportSetup = useCallback(() => {
    const setup = {
      components,
      simulationSettings,
    };
    downloadJSON(setup, 'optical-setup.json');
  }, [components, simulationSettings]);

  // Import setup from JSON
  const handleImportSetup = useCallback((file: File) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const content = e.target?.result as string;
        const setup = JSON.parse(content);
        
        if (setup.components && Array.isArray(setup.components)) {
          setComponents(setup.components);
        }
        
        if (setup.simulationSettings) {
          setSimulationSettings(setup.simulationSettings);
        }
        
        alert('Setup imported successfully!');
      } catch (error) {
        console.error('Import failed:', error);
        alert('Failed to import setup. Please check the file format.');
      }
    };
    reader.readAsText(file);
  }, []);

  return (
    <div className="h-screen w-screen flex flex-col bg-gray-950">
      {/* Header */}
      <header className="bg-gray-900 border-b border-gray-700 px-6 py-4">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-white">Optical Setup Designer</h1>
            <p className="text-sm text-gray-400">
              Design and simulate optical systems
            </p>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-sm text-gray-400">
              Components: <span className="text-white font-medium">{components.length}</span>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div className="flex-1 flex overflow-hidden">
        <ReactFlowProvider>
          <Sidebar onAddComponent={handleAddComponent} />
          
          <Canvas
            components={components}
            selectedId={selectedId}
            onSelectComponent={setSelectedId}
            onUpdateComponent={handleUpdateComponent}
            rays={simulationResult?.rays || []}
          />
          
          <PropertiesPanel
            selectedComponent={selectedComponent}
            onUpdateComponent={handleUpdateComponent}
            onDeleteComponent={handleDeleteComponent}
          />
        </ReactFlowProvider>
      </div>

      {/* Simulation Panel */}
      <SimulationPanel
        settings={simulationSettings}
        onSettingsChange={setSimulationSettings}
        onRunSimulation={handleRunSimulation}
        onExportSetup={handleExportSetup}
        onImportSetup={handleImportSetup}
        simulationResult={simulationResult}
        isSimulating={isSimulating}
      />
    </div>
  );
}

export default App;
